# fastapi

## Alembic Commands

Create a Autogenerated Migration file

`> alembic revision --autogenerate -m "comment"`

Get the current head

`> alembic heads`

Run migration

`> alembic upgrade head`

## DigitalOcean - Ubuntu VM

Login to VM in terminal

`> ssh@root<ip>`

List all the users in Ubuntu VM

`> sudo cat /etc/passwd`

Switch to different user

`> su - <username>`

Restart an app

`> systemctl restart postgresql`

Create a new user in Ubuntu

`> adduser <username>`

Login with the new user

`> ssh@<username><ip>`

Provide root access to the new user

`> usermod -aG sudo <username>`

## Virtual Environment in Ubuntu

Create Virtual Environment

`> virtualenv venv`

Activate Virtual Environment

`> source venv\bin\activate`

Deactivate Virtual Environment

`> deactivate`

## Environment Variables in Ubuntu

Setting Environment Variable

`> export ENV_VAR=variablename`

Print all the environment variable

`> printenv`

Remove Environment Variable

`> unset ENV_VAR`

**Add multiple environment variables**

1. Create a .env file in /home/shashank `> touch .env`
2. Edit the .env file `> vi .env`
    ```
    export MY_NAME=shashank
    export MY_PASSWORD=password123
    ```
3. Run `> source .env`

If .env file is in below format,

```
MY_NAME=shashank
MY_PASSWORD=password123
```

run `> set -o allexport; source /home/shashank/.env; set +o allexport`

If the system is rebooted, all the environment variables set are removed. To make the env variable persistent, edit the .profile, located at the home directory(/home/shashank) and add the above command at the end of the file.

## Running application on Ubuntu

1. Install gunicorn.
2. Run `> cd /etc/systemd/system`.
3. Create a service file: `> sudo vi api.service` - Here the file name can be anything. We will use the file name to start the service. In this case we will use 'api'.
4. Copy the content of the `gunicorn.service` file to `api.service` file.
5. Run `> systemctl start api`

To check the status: `> systemctl status api`

To restart the service: `> systemctl restart api`

Start the service automatically after reboot: `> sudo systemctl enable api`

## NGINX

-   High performance webserver that can act as a proxy.
-   Can handle SSL termination.

![Nginx](nginx.png)

### Setup Nginx

1. Install nginx `> sudo apt install nginx -y`
2. Navigate to `> cd /etc/nginx/sites-avilable/`
3. Edit `default` file. (Check nginx-default file)
4. Start the nginx service. `> systemctl start nginx`

## Enable SSL/HTTPS

Use certbot

## Enable Firewall

Check firewall status: `> sudo ufw status`

Allow traffic:

`> sudo ufw allow http`

`> sudo ufw allow https`

`> sudo ufw allow ssh`

`> sudo ufw allow 5432` (if you want to allow traffic for postgresql db)

Enable firewall: `> sudo ufw enable`
